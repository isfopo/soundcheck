name: Release Homebrew

on:
  workflow_run:
    workflows: ["Release Core"]
    types:
      - completed

env:
  CARGO_TERM_COLOR: always

jobs:
  generate-formula:
    name: Generate Homebrew Formula
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from workflow run
      id: get_version
      run: |
        # Get the tag from the triggering workflow
        TAG=$(curl -s "${{ github.event.workflow_run.artifacts_url }}" | jq -r '.artifacts[0].name' | sed 's/binaries-.*//')
        if [ -z "$TAG" ]; then
          # Fallback: get latest tag
          TAG=$(curl -s "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest" | jq -r '.tag_name')
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Generate Homebrew formula
      run: |
        REPO_NAME="${GITHUB_REPOSITORY#*/}"
        TAG="${{ steps.get_version.outputs.tag }}"

        # Calculate SHA256 for macOS x86_64 binary
        MACOS_X86_SHA=$(curl -sL "https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/standby-x86_64-apple-darwin.tar.gz" | sha256sum | cut -d' ' -f1)
        MACOS_ARM_SHA=$(curl -sL "https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/standby-aarch64-apple-darwin.tar.gz" | sha256sum | cut -d' ' -f1)

        FORMULA=$(cat << EOF
        class Standby < Formula
          desc "Terminal-based audio monitoring application"
          homepage "https://github.com/${GITHUB_REPOSITORY}"
          url "https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/standby-x86_64-apple-darwin.tar.gz"
          sha256 "${MACOS_X86_SHA}"
          version "${TAG#v}"

          on_macos do
            if Hardware::CPU.arm?
              url "https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/standby-aarch64-apple-darwin.tar.gz"
              sha256 "${MACOS_ARM_SHA}"
            end
          end

          def install
            bin.install "standby"
          end

          test do
            system "#{bin}/standby", "--help"
          end
        end
        EOF
        )

        echo "$FORMULA" > standby.rb

    - name: Upload formula artifact
      uses: actions/upload-artifact@v4
      with:
        name: homebrew-formula
        path: standby.rb

  update-tap:
    name: Update Homebrew Tap
    needs: generate-formula
    runs-on: ubuntu-latest
    if: github.event.repository.fork == false

    steps:
    - name: Checkout tap repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}-homebrew-tap
        path: tap-repo
        token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

    - name: Download formula
      uses: actions/download-artifact@v4
      with:
        name: homebrew-formula
        path: .

    - name: Get version
      id: get_version
      run: |
        VERSION=$(cat standby.rb | grep "version" | head -1 | sed 's/.*version "\([^"]*\)".*/\1/')
        echo "version=v$VERSION" >> $GITHUB_OUTPUT

    - name: Commit and push formula
      run: |
        cd tap-repo
        cp ../standby.rb Formula/standby.rb

        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add Formula/standby.rb

        if git diff --staged --quiet; then
          echo "No changes to formula"
        else
          git commit -m "Update standby to ${{ steps.get_version.outputs.version }}"
          git push
        fi

  submit-core:
    name: Submit to Homebrew Core
    needs: generate-formula
    runs-on: ubuntu-latest
    if: github.event.repository.fork == false

    steps:
    - name: Checkout homebrew-core
      uses: actions/checkout@v4
      with:
        repository: Homebrew/homebrew-core
        path: homebrew-core

    - name: Download formula
      uses: actions/download-artifact@v4
      with:
        name: homebrew-formula
        path: .

    - name: Get version
      id: get_version
      run: |
        VERSION=$(cat standby.rb | grep "version" | head -1 | sed 's/.*version "\([^"]*\)".*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Check if formula exists
      id: check_formula
      run: |
        if [ -f "homebrew-core/Formula/s/standby.rb" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Update existing formula
      if: steps.check_formula.outputs.exists == 'true'
      run: |
        cp standby.rb homebrew-core/Formula/s/standby.rb
        cd homebrew-core
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git checkout -b "standby-${{ steps.get_version.outputs.version }}"
        git add Formula/s/standby.rb
        git commit -m "standby ${{ steps.get_version.outputs.version }}

        Update standby to version ${{ steps.get_version.outputs.version }}."

    - name: Create new formula
      if: steps.check_formula.outputs.exists == 'false'
      run: |
        cp standby.rb homebrew-core/Formula/s/standby.rb
        cd homebrew-core
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git checkout -b "standby-${{ steps.get_version.outputs.version }}"
        git add Formula/s/standby.rb
        git commit -m "standby ${{ steps.get_version.outputs.version }}

        Terminal-based audio monitoring application.

        Monitors audio input levels and detects when sound exceeds a threshold."

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        path: homebrew-core
        token: ${{ secrets.HOMEBREW_CORE_TOKEN }}
        branch: standby-${{ steps.get_version.outputs.version }}
        title: "standby ${{ steps.get_version.outputs.version }}"
        body: |
          ## standby ${{ steps.get_version.outputs.version }}

          Terminal-based audio monitoring application that displays real-time audio levels and detects when sound exceeds a specified threshold.

          ### Changes
          - Update standby to version ${{ steps.get_version.outputs.version }}

          ### Formula
          \`\`\`ruby
          $(cat ../standby.rb)
          \`\`\`

          ---

          Created by [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        commit-message: "standby ${{ steps.get_version.outputs.version }}"
        author: "GitHub Actions <actions@github.com>"
        delete-branch: true